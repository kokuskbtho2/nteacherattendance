<!doctype html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEM KEHADIRAN KOKURIKULUM GURU</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #740202 0%, #dc2626 100%); 
            min-height: 100vh; display: flex; align-items: center; justify-content: center; 
            padding: 20px; overflow: hidden; position: relative;
        }
        /* Lapisan Penutup (Overlay) untuk halang kelipan borang */
        #loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100; display: flex; flex-direction: column;
            align-items: center; justify-content: center; border-radius: 40px;
        }
        .canva-card { 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); width: 100%; max-width: 480px; 
            padding: 35px 20px; border-radius: 40px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6); 
            text-align: center; position: relative; z-index: 10; min-height: 400px;
        }
        .logo-img { width: 85px; margin: 0 auto 15px auto; display: block; cursor: pointer; }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .status-box { border: 3px solid #f3f4f6; padding: 15px 5px; border-radius: 20px; cursor: pointer; transition: all 0.3s; background: white; }
        .status-box.active-hadir { border-color: #10b981; background: #ecfdf5; }
        .status-box.active-tak-hadir { border-color: #f59e0b; background: #fffbeb; }
        .select-style { width: 100%; padding: 16px; border: 2px solid #fee2e2; border-radius: 18px; margin-bottom: 20px; font-weight: 600; }
        .btn-detect { background-color: #4b5563; color: white; padding: 15px; border-radius: 15px; width: 100%; font-weight: 600; margin-bottom: 12px; }
        .btn-clockin { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; padding: 18px; border-radius: 18px; width: 100%; font-weight: 700; }
        .btn-clockin:disabled { background: #d1d5db; opacity: 0.6; }
    </style>
</head>
<body>

<div class="canva-card" id="mainCard">
    <div id="loading-overlay">
        <div class="w-12 h-12 border-4 border-red-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <div class="text-sm font-bold text-gray-500 animate-pulse">MENYEMAK STATUS SISTEM...</div>
    </div>

    <div id="content-area">
        <div onclick="handleSecretClick()">
            <img src="https://imgur.com/DLy3jZn.png" class="logo-img">
        </div>

        <h1 class="font-bold text-gray-800 uppercase mb-1" style="font-size: clamp(12px, 4vw, 18px);">
            SISTEM KEHADIRAN KOKURIKULUM GURU
        </h1>
        <p class="text-red-600 font-bold tracking-[0.2em] uppercase mb-8" style="font-size: clamp(9px, 2.5vw, 11px);">
            SK BANDAR TUN HUSSEIN ONN 2
        </p>

        <div id="formSection" style="display: none;">
            <div class="status-grid">
                <div id="boxHadir" class="status-box active-hadir" onclick="selectStatus('HADIR')">
                    <div class="text-2xl mb-1">‚úÖ</div>
                    <div class="text-[11px] font-bold text-green-700">HADIR</div>
                </div>
                <div id="boxTakHadir" class="status-box" onclick="selectStatus('TIDAK HADIR')">
                    <div class="text-2xl mb-1">‚ùå</div>
                    <div class="text-[11px] font-bold text-amber-600">TIDAK HADIR</div>
                </div>
            </div>

            <select id="teacherName" class="select-style">
                <option value="">-- MEMUAT SENARAI... --</option>
            </select>

            <button id="detectBtn" class="btn-detect" onclick="detectLocation()">üîç SAHKAN LOKASI SAYA</button>
            <button id="inBtn" class="btn-clockin" onclick="saveRecord()" disabled>HANTAR KEHADIRAN</button>
        </div>

        <div id="blockSection" class="hidden py-10">
            <div class="text-6xl mb-4">üéâ</div>
            <h2 class="text-green-600 font-bold text-xl uppercase">Rekod Diterima</h2>
            <p class="text-gray-500 text-sm mt-2">Terima kasih, kehadiran anda telah direkodkan.</p>
        </div>
    </div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzdI4aGxMenu6kSeXKRYABJFJ_3dWEeqVYkXY6_cjZ3MrPKpaIdnPScRzYnZpsWQTfS/exec";
    let selectedStatus = "HADIR";
    let userLat = ""; let userLng = ""; let clickCount = 0; let clickTimer;

    const senaraiGuru = [
    "RUHAIZA BINTI JUPRI",
    "AQILAH IZZATI BINTI AZAM FAIRUZ",
    "MOHD ZAIRUZI BIN MOHD NOR",
    "NOR IDAWATI BINTI ABU HASAN",
    "FARHANA BINTI ABDULLAH",
    "SYARFIZA BINTI ABDUL WAHAB SHAARANI",
    "ROSNIZA BINTI MOHD YUSOFF",
    "SITI NAZRIAH BINTI SANIN",
    "NOR' ATIKAH BINTI ABDUL LATIF",
    "NAGINIDEVI A/P RATHAKRUSHNAN",
    "ASMAT BINTI MUSTAPHA",
    "MUHAMMAD FARIS BIN MANSOR",
    "MUHAMMAD IKHWAN BIN WAN AZELEE",
    "HEME PRIYA DEVI A/P THIAGARAJAN",
    "NUR FARAH WAHIDA BINTI MAT ANI",
    "ATHIRAH SYAHIRA BINTI ISHAK",
    "NUR KHADIJAH BINTI ZAHARIMAN",
    "SAIZA NINEY NABIHA BINTI SAIFUL BAHARI",
    "ZURAINI BINTI ABDULLAH",
    "BANU PRIYA A/P SIVAPRAGASAM",
    "BAIRIRAH BINTI RAMLI",
    "ZIZIE ZAWANAH BINTI ZULKIFLI",
    "IZZATI IIMAN BINTI ISMAIL",
    "ZAKIRI BIN AB HAMID",
    "NURUL HALIZA ILYANA BINTI MOHD RAZALI",
    "SUNITA BINTI RODZI",
    "MOHD AIMAN FARID BIN ALIAS",
    "SITI HAJAR BINTI AB RAHIM",
    "ANPARSY A/P MUTHUSAMY",
    "ANISMAZIHA BINTI MOHD ZIN",
    "SITI NAZIRAH BINTI MAT RAHIM",
    "SURIANY BINTI IBRAHIM",
    "HARYATI BINTI MAULAN",
    "MOHD REDHUAN BIN HJ ARSHAD",
    "UMMU HANISAH BINTI ZAINUDDIN",
    "NUR FARHANI BINTI ZAKARIA",
    "SUMAYYAH BINTI JOHAIDI",
    "WAN NUR ATIQAH BINTI WAN ZAKARIA",
    "STEPHANIE NYSSA GOMEZ",
    "NOR'AIN BINTI OTHMAN",
    "SOFIAN A/L SANGUAN",
    "TUAN NUR AFIFAH BINTI TUAN OMAR",
    "NUR INTAN NAZIFAH BINTI SHAMSURI",
    "NURIZYAN BINTI ZAINUDDIN",
    "NURUL ATIKAH BINTI BUKHARI",
    "NUR HIDAYAH BINTI MUHD SAFAR",
    "NUR SYUHADA BINTI ABDUL WAHAB",
    "SITI ZALEHA BINTI YUSOFF",
    "SHUKRIAH BINTI AHMAD",
    "KHAIRIAH BINTI HUSIN",
    "NURUL FARIHA BINTI MAULAD JAAFAR",
    "HABSAH BINTI CHE SOM",
    "AZLINA BINTI ALIAS",
    "MOHAMAD FIRDAUS BIN ZAINOL",
    "SHARIFAH NUR WHIDA BINTI SYED YAZIZ",
    "NURUL KHAIRUNIE BINTI MAHTAR",
    "NOR ZAHIRAH BINTI ZAKARIA",
    "MOHD NASIR BIN ZAKARIA",
    "MUHAMMAD HARIZ BIN HASSAN",
    "NOR AMIN BIN MAT NOR",
    "ZAITON BINTI MOHAMAD",
    "SITI NAHARIAH BINTI ALI"
];
    window.onload = async function() {
        const overlay = document.getElementById('loading-overlay');
        const formSection = document.getElementById('formSection');
        const contentArea = document.getElementById('content-area');
        const today = new Date().toLocaleDateString();

        try {
            // 1. Cek Status Kunci Serta-merta
            const statusResp = await fetch(`${WEB_APP_URL}?action=getStatus`);
            const systemStatus = await statusResp.text();
            
            if (systemStatus === "closed") {
                contentArea.innerHTML = `
                    <div class="py-20 text-center">
                        <div class="text-7xl mb-6">üîí</div>
                        <h2 class="text-red-600 font-bold text-2xl uppercase">SISTEM DITUTUP</h2>
                        <p class="text-gray-500 mt-4">Maaf, admin telah menutup sesi kehadiran hari ini.</p>
                        <button onclick="adminControl()" class="mt-8 text-xs text-gray-300">Admin Only</button>
                    </div>`;
                overlay.style.display = "none";
                return;
            }

            // 2. Cek Jika Peranti Ini Dah Hantar (Local Check)
            if(localStorage.getItem('last_submit_date') === today) {
                document.getElementById('formSection').classList.add('hidden');
                document.getElementById('blockSection').classList.remove('hidden');
                overlay.style.display = "none";
                return;
            }

            // 3. Muat Senarai Nama
            const resp = await fetch(WEB_APP_URL);
            const namesDone = await resp.json();
            const select = document.getElementById('teacherName');
            select.innerHTML = '<option value="">-- SILA PILIH NAMA --</option>';
            senaraiGuru.sort().forEach(nama => {
                let opt = document.createElement('option');
                opt.value = nama; 
                opt.innerHTML = namesDone.includes(nama) ? "‚úÖ " + nama : nama;
                select.appendChild(opt);
            });

            formSection.style.display = "block";
            overlay.style.display = "none";

        } catch(e) {
            overlay.innerHTML = "<div class='p-4 text-center'>Ralat Sambungan. Sila refresh semula.</div>";
        }
    }

    function selectStatus(val) {
        selectedStatus = val;
        document.getElementById('boxHadir').className = 'status-box' + (val === 'HADIR' ? ' active-hadir' : '');
        document.getElementById('boxTakHadir').className = 'status-box' + (val === 'TIDAK HADIR' ? ' active-tak-hadir' : '');
        document.getElementById('inBtn').disabled = true;
    }

    function detectLocation() {
        navigator.geolocation.getCurrentPosition((pos) => {
            userLat = pos.coords.latitude; userLng = pos.coords.longitude;
            const schoolLat = 3.052485; const schoolLog = 101.754269;
            const R = 6371e3;
            const d1 = schoolLat * Math.PI/180; const d2 = userLat * Math.PI/180;
            const df = (userLat-schoolLat) * Math.PI/180; const dl = (userLng-schoolLog) * Math.PI/180;
            const a = Math.sin(df/2) * Math.sin(df/2) + Math.cos(d1) * Math.cos(d2) * Math.sin(dl/2) * Math.sin(dl/2);
            const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            if (selectedStatus === "HADIR") {
                if (dist <= 500) { document.getElementById('inBtn').disabled = false; alert("LOKASI DISAHKAN!"); }
                else { alert("ANDA DI LUAR KAWASAN SEKOLAH!"); }
            } else {
                document.getElementById('inBtn').disabled = false; alert("LOKASI DIREKODKAN.");
            }
        }, () => alert("Sila benarkan akses GPS."), { enableHighAccuracy: true });
    }

    function saveRecord() {
        const nama = document.getElementById('teacherName').value;
        if (!nama) return alert("Sila pilih nama!");
        const uniqueID = (navigator.userAgent + screen.width + screen.height).replace(/\s+/g, '');

        document.getElementById('inBtn').innerText = "MENYEMAK...";
        document.getElementById('inBtn').disabled = true;

        fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify({ nama: nama, status: selectedStatus, lat: userLat, lng: userLng, deviceId: uniqueID })
        })
        .then(res => res.text())
        .then(result => {
            if (result === "DUPLICATE_NAME") alert("Nama anda sudah direkodkan!");
            else if (result === "LIMIT_DEVICE") alert("Satu peranti hanya untuk satu nama!");
            else if (result === "Success") {
                localStorage.setItem('last_submit_date', new Date().toLocaleDateString());
                alert("BERJAYA!");
            }
            location.reload();
        });
    }

    function handleSecretClick() {
        clickCount++; clearTimeout(clickTimer);
        if (clickCount === 3) { adminControl(); clickCount = 0; }
        else { clickTimer = setTimeout(() => { clickCount = 0; }, 500); }
    }

    function adminControl() {
        const pass = prompt("MOD ADMIN:");
        if(pass === "KOKU4055") {
            alert("Menukar status sistem...");
            fetch(`${WEB_APP_URL}?action=toggle`)
            .then(res => res.text())
            .then(result => { alert(result); location.reload(); });
        }
    }
</script>
</body>
</html>
